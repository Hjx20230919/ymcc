<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.com.cnpc.cpoa.mapper.project.BizProjSelContDtoMapper">

    <resultMap id="BaseResultMap" type="cn.com.cnpc.cpoa.domain.project.BizProjSelContDto">
        <result column="SEL_CONT_ID" jdbcType="VARCHAR" property="selContId"/>
        <result column="PROJ_ID" jdbcType="VARCHAR" property="projId"/>
        <result column="ATTACH_NUM" jdbcType="INTEGER" property="attachNum"/>
        <result column="CREATE_ID" jdbcType="VARCHAR" property="createId"/>
        <result column="OWNER_DEPT_ID" jdbcType="VARCHAR" property="ownerDeptId"/>
        <result column="CONT_QLY_REQ" jdbcType="VARCHAR" property="contQlyReq"/>
        <result column="PROJ_STATUS" jdbcType="VARCHAR" property="projStatus"/>
        <result column="PROJ_PHASE" jdbcType="VARCHAR" property="projPhase"/>
        <result column="CREATE_AT" jdbcType="TIMESTAMP" property="createAt"/>
        <result column="NOTES" jdbcType="VARCHAR" property="notes"/>
    </resultMap>

    <resultMap id="BaseResultMap2" type="cn.com.cnpc.cpoa.domain.project.BizProjProjectDto">
        <result column="SEL_CONT_ID" jdbcType="VARCHAR" property="selContId"/>
        <result column="PROJ_ID" jdbcType="VARCHAR" property="projId"/>
        <result column="PROJ_NAME" jdbcType="VARCHAR" property="projName"/>
        <result column="DEAL_VALUE" jdbcType="DECIMAL" property="dealValue"/>
        <result column="DEAL_NAME" jdbcType="VARCHAR" property="dealName"/>
        <result column="PROJ_STATUS" jdbcType="VARCHAR" property="projStatus"/>
        <result column="PROJ_PHASE" jdbcType="VARCHAR" property="projPhase"/>
        <result column="CONT_QLY_REQ" jdbcType="VARCHAR" property="contQlyReq"/>
        <result column="SEL_CONT_TYPE" jdbcType="VARCHAR" property="selContType"/>
        <result column="CREATE_AT" jdbcType="TIMESTAMP" property="createAt"/>
        <result column="USER_NAME" jdbcType="VARCHAR" property="userName"/>
        <result column="DEPT_NAME" jdbcType="VARCHAR" property="deptName"/>
        <result column="ATTACH_NUM" jdbcType="VARCHAR" property="attachNum"/>
        <result column="DEAL_CONTRACT" jdbcType="VARCHAR" property="dealContract"/>
        <result column="PLAN_ID" jdbcType="VARCHAR" property="planId"/>
        <result column="RESULT_ID" jdbcType="VARCHAR" property="resultId"/>
        <result column="DEAL_NO" jdbcType="VARCHAR" property="dealNo"/>
        <result column="NOTES" jdbcType="VARCHAR" property="notes"/>
    </resultMap>

    <!--查询选商基础信息-->
    <select id="selectProjSelCont" parameterType="java.util.Map" resultMap="BaseResultMap2">
        SELECT TPP.PROJ_ID,TPP.PROJ_NAME,TPP.DEAL_VALUE,TPP.DEAL_NAME,TPP.DEAL_NO,TPSC.PROJ_STATUS,TPP.PROJ_PHASE,IFNULL(TPSC.CONT_QLY_REQ,TPP.CONT_QLY_REQ) CONT_QLY_REQ,
        TPP.SEL_CONT_TYPE,TPSC.CREATE_AT,TSU.USER_NAME,TSD.DEPT_NAME,TPSC.SEL_CONT_ID,TPSC.ATTACH_NUM,TPP.DEAL_CONTRACT,TPPP.PLAN_ID,TPPR.RESULT_ID,TPSC.NOTES
        FROM T_PROJ_SEL_CONT TPSC
        LEFT JOIN T_PROJ_PROJECT TPP ON TPP.PROJ_ID=TPSC.PROJ_ID
        LEFT JOIN T_PROJ_PURC_PLAN TPPP  ON TPPP.PROJ_ID=TPSC.PROJ_ID
        LEFT JOIN T_PROJ_PURC_RESULT TPPR  ON TPPR.PROJ_ID=TPSC.PROJ_ID
        LEFT JOIN T_SYS_USER TSU ON TPP.CREATE_ID=TSU.USER_ID
        LEFT JOIN T_SYS_DEPT TSD ON TPP.OWNER_DEPT_ID=TSD.DEPT_ID

        <where>
            <if test="selContId!=null and selContId!=''">
                and TPSC.SEL_CONT_ID =#{selContId}
            </if>
            <if test="selContType!=null and selContType!=''">
                and TPP.SEL_CONT_TYPE =#{selContType}
            </if>


            <if test="projId!=null and projId!=''">
                and TPSC.PROJ_ID =#{projId}
            </if>


            <if test="projName!=null and projName!=''">
                and TPP.PROJ_NAME LIKE CONCAT('%',#{projName},'%')
            </if>

            <if test="dealNo!=null and dealNo!=''">
                and TPP.DEAL_NO LIKE CONCAT('%',#{dealNo},'%')
            </if>

            <if test="projStatus!=null and projStatus!=''">
                and TPSC.PROJ_STATUS=#{projStatus}
            </if>
            <if test="userName!=null and userName!=''">
                and TSU.USER_NAME LIKE CONCAT('%',#{userName},'%')
            </if>

            <if test="deptName!=null and deptName!=''">
                and TSD.DEPT_NAME LIKE CONCAT('%',#{deptName},'%')
            </if>

            <if test="createAtStart!=null and createAtStart!=''">
                and TPSC.CREATE_AT>= str_to_date(#{createAtStart},'%Y-%m-%d %H:%i:%s')
            </if>

            <if test="createAtEnd!=null and createAtEnd!=''">
                and TPSC.CREATE_AT &lt;= str_to_date(#{createAtEnd},'%Y-%m-%d %H:%i:%s')
            </if>


            <!--数据权限-->
            <if test="dataScopeDept!=null and dataScopeDept!=''">
                AND TSD.DEPT_ID=#{dataScopeDept}
            </if>

            <if test="dataScopeSelf!=null and dataScopeSelf!=''">
                AND TSU.USER_ID = #{dataScopeSelf}
            </if>
        </where>

        ORDER BY TPSC.CREATE_AT DESC
    </select>


    <!--审核查询-->
    <select id="selectAuditProjSelCont" parameterType="java.util.Map" resultMap="BaseResultMap2">
        SELECT
        TPP.PROJ_ID,TPP.PROJ_NAME,TPP.SEL_CONT_TYPE,TPP.DEAL_VALUE,TPP.DEAL_NAME,TPSC.PROJ_STATUS,TPSC.PROJ_PHASE,TPSC.CREATE_AT,TPSC.CONT_QLY_REQ,
        TSD.DEPT_NAME,TSU.USER_NAME,TPSC.SEL_CONT_ID,TPPP.PLAN_ID,TPPR.RESULT_ID
        FROM T_PROJ_SEL_CONT TPSC
        INNER JOIN (
        SELECT IFNULL(MIN(TBCS.STEP_NO),-1) STEP_NO,TPSC.SEL_CONT_ID FROM T_PROJ_SEL_CONT TPSC
        INNER JOIN T_BIZ_CHECK_STEP TBCS ON TBCS.CHECK_OBJ_ID=TPSC.SEL_CONT_ID
        INNER JOIN T_BIZ_CHECK_MAN TBCM ON TBCS.STEP_ID=TBCM.STEP_ID
        WHERE TPSC.PROJ_STATUS='auditing'
        AND TBCM.CHECK_STATE='PENDING'
        GROUP BY TPSC.SEL_CONT_ID ) A
        ON TPSC.SEL_CONT_ID=A.SEL_CONT_ID
        INNER JOIN (
        SELECT MIN(TBCS.STEP_NO) STEP_NO,TBCS.CHECK_OBJ_ID FROM T_BIZ_CHECK_STEP TBCS
        INNER JOIN T_BIZ_CHECK_MAN TBCM ON TBCS.STEP_ID=TBCM.STEP_ID
        WHERE TBCM.USER_ID=#{userId}
        AND TBCM.CHECK_STATE='PENDING'
        GROUP BY TBCS.CHECK_OBJ_ID
        ) B ON A.STEP_NO=B.STEP_NO
        AND A.SEL_CONT_ID=B.CHECK_OBJ_ID
        LEFT JOIN T_PROJ_PROJECT TPP ON TPP.PROJ_ID=TPSC.PROJ_ID
        LEFT JOIN T_PROJ_PURC_PLAN TPPP  ON TPPP.PROJ_ID=TPSC.PROJ_ID
        LEFT JOIN T_PROJ_PURC_RESULT TPPR  ON TPPR.PROJ_ID=TPSC.PROJ_ID
        LEFT JOIN T_SYS_DEPT TSD ON TPP.OWNER_DEPT_ID=TSD.DEPT_ID
        LEFT JOIN T_SYS_USER TSU ON TPP.CREATE_ID=TSU.USER_ID

        <where>
            <if test="projName!=null and projName!=''">
                and TPP.PROJ_NAME LIKE CONCAT('%',#{projName},'%')
            </if>

            <if test="projStatus!=null and projStatus!=''">
                and TPSC.PROJ_STATUS=#{projStatus}
            </if>
            <if test="userName!=null and userName!=''">
                and TSU.USER_NAME LIKE CONCAT('%',#{userName},'%')
            </if>

            <if test="deptName!=null and deptName!=''">
                and TSD.DEPT_NAME LIKE CONCAT('%',#{deptName},'%')
            </if>

            <if test="createAtStart!=null and createAtStart!=''">
                and TPSC.CREATE_AT>= str_to_date(#{createAtStart},'%Y-%m-%d %H:%i:%s')
            </if>

            <if test="createAtEnd!=null and createAtEnd!=''">
                and TPSC.CREATE_AT &lt;= str_to_date(#{createAtEnd},'%Y-%m-%d %H:%i:%s')
            </if>
        </where>
        ORDER BY TPSC.CREATE_AT DESC

    </select>

    <!--已审核查询-->
    <select id="selectAuditedProjSelCont" parameterType="java.util.Map" resultMap="BaseResultMap2">
        SELECT
        TPP.PROJ_ID,TPP.PROJ_NAME,TPP.SEL_CONT_TYPE,TPP.DEAL_VALUE,TPP.DEAL_NAME,TPSC.PROJ_STATUS,TPSC.PROJ_PHASE,TPSC.CREATE_AT,TPSC.CONT_QLY_REQ,
        TSD.DEPT_NAME,TSU.USER_NAME,TPSC.SEL_CONT_ID,TPPP.PLAN_ID,TPPR.RESULT_ID
        FROM T_PROJ_SEL_CONT TPSC
        INNER JOIN (
        SELECT TPSC.SEL_CONT_ID FROM T_PROJ_SEL_CONT TPSC
        INNER JOIN T_BIZ_CHECK_STEP TBCS ON TBCS.CHECK_OBJ_ID=TPSC.SEL_CONT_ID
        INNER JOIN T_BIZ_CHECK_MAN TBCM ON TBCS.STEP_ID=TBCM.STEP_ID
        WHERE TBCM.CHECK_STATE='PENDED' AND TBCM.USER_ID=#{userId}
        GROUP BY TPSC.SEL_CONT_ID ) A
        ON TPSC.SEL_CONT_ID=A.SEL_CONT_ID
        LEFT JOIN T_PROJ_PROJECT TPP ON TPP.PROJ_ID=TPSC.PROJ_ID
        LEFT JOIN T_PROJ_PURC_PLAN TPPP  ON TPPP.PROJ_ID=TPSC.PROJ_ID
        LEFT JOIN T_PROJ_PURC_RESULT TPPR  ON TPPR.PROJ_ID=TPSC.PROJ_ID
        LEFT JOIN T_SYS_DEPT TSD ON TPP.OWNER_DEPT_ID=TSD.DEPT_ID
        LEFT JOIN T_SYS_USER TSU ON TPP.CREATE_ID=TSU.USER_ID

        <where>
            <if test="projName!=null and projName!=''">
                and TPP.PROJ_NAME LIKE CONCAT('%',#{projName},'%')
            </if>

            <if test="projStatus!=null and projStatus!=''">
                and TPSC.PROJ_STATUS=#{projStatus}
            </if>
            <if test="userName!=null and userName!=''">
                and TSU.USER_NAME LIKE CONCAT('%',#{userName},'%')
            </if>

            <if test="deptName!=null and deptName!=''">
                and TSD.DEPT_NAME LIKE CONCAT('%',#{deptName},'%')
            </if>

            <if test="createAtStart!=null and createAtStart!=''">
                and TPSC.CREATE_AT>= str_to_date(#{createAtStart},'%Y-%m-%d %H:%i:%s')
            </if>

            <if test="createAtEnd!=null and createAtEnd!=''">
                and TPSC.CREATE_AT &lt;= str_to_date(#{createAtEnd},'%Y-%m-%d %H:%i:%s')
            </if>
        </where>
        ORDER BY TPSC.CREATE_AT DESC

    </select>
    <select id="selectByprojId" resultType="cn.com.cnpc.cpoa.domain.project.BizProjSelContDto">
        select * from T_PROJ_SEL_CONT t where t.SEL_CONT_ID =#{selContId}
    </select>
    <update id="updateByselContId">
        update T_PROJ_SEL_CONT t SET PROJ_STATUS=#{projStatus} WHERE t.SEL_CONT_ID =#{selContId};

    </update>


</mapper>