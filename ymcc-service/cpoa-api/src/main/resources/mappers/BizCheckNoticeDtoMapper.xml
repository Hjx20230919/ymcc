<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.com.cnpc.cpoa.mapper.BizCheckNoticeDtoMapper">

    <resultMap id="BaseResultMap" type="cn.com.cnpc.cpoa.domain.BizCheckNoticeDto">

        <result column="NOTICE_ID" jdbcType="VARCHAR" property="noticeId"/>
        <result column="NOTICE_OBJ_ID" jdbcType="VARCHAR" property="noticeObjId"/>
        <result column="NOTICE_OBJ_TYPE" jdbcType="VARCHAR" property="noticeObjType"/>
        <result column="NOTICE_TYPE" jdbcType="VARCHAR" property="noticeType"/>
        <result column="NOTICE_USER_ID" jdbcType="VARCHAR" property="noticeUserId"/>
        <result column="NOTICE_CREATE_AT" jdbcType="TIMESTAMP" property="noticeCreateAt"/>
        <result column="NOTICE_SEND_STATE" jdbcType="VARCHAR" property="noticeSendState"/>
        <result column="NOTICE_SEND_TEMP" jdbcType="VARCHAR" property="noticeSendTemp"/>
        <result column="NOTICE_SEND_CONTENT" jdbcType="VARCHAR" property="noticeSendContent"/>
        <result column="NOTICE_SEND_TIME" jdbcType="TIMESTAMP" property="noticeSendTime"/>
        <result column="NOTICE_SEND_RETRY" jdbcType="VARCHAR" property="noticeSendRetry"/>
        <result column="NOTICE_NOTE" jdbcType="VARCHAR" property="noticeNote"/>
        <result column="STEP_ID" jdbcType="VARCHAR" property="stepId"/>
        <result column="MAN_ID" jdbcType="VARCHAR" property="manId"/>
    </resultMap>
    <!--查询合同类别-->
    <select id="selectList" parameterType="java.util.Map" resultMap="BaseResultMap">
        select * from T_BIZ_CHECK_NOTICE TBN
        <where>
            <if test="noticeObjId!=null and noticeObjId!=''">
                and TBN.NOTICE_OBJ_ID=#{noticeObjId}
            </if>

        </where>

    </select>

    <!--查询合同类别-->
    <select id="getSendMessage" parameterType="java.util.Map" resultMap="BaseResultMap">

    select * from  T_BIZ_CHECK_NOTICE TBC WHERE TBC.NOTICE_SEND_STATE ='pending'
    OR (
      TBC.NOTICE_SEND_STATE ='fail' AND TBC.NOTICE_SEND_RETRY &lt;3
    )

  </select>

    <!--查询今日之前未审批-->
    <select id="selectNextday" parameterType="java.util.Map" resultMap="BaseResultMap">

    SELECT B.STEP_ID,B.MAN_ID,B.CHECK_OBJ_ID NOTICE_OBJ_ID,'deal' NOTICE_OBJ_TYPE,IFNULL(B.STEP_BEGIN_AT,NOW()) NOTICE_SEND_TIME FROM (
    SELECT IFNULL(MIN(TBCS.STEP_NO),-1) STEP_NO,TBD.DEAL_ID FROM  T_BIZ_DEAL TBD
    INNER JOIN T_BIZ_CHECK_STEP TBCS ON TBCS.CHECK_OBJ_ID=TBD.DEAL_ID
    INNER JOIN T_BIZ_CHECK_MAN TBCM ON TBCS.STEP_ID=TBCM.STEP_ID
    WHERE TBD.DEAL_STATUS in ('buildAuditing','changeAuditing')
    AND TBCM.CHECK_STATE='PENDING'
    GROUP BY TBD.DEAL_ID) A
    INNER JOIN  (

    SELECT MIN(TBCS.STEP_NO) STEP_NO,TBCS.CHECK_OBJ_ID,TSU.USER_ID,TBCS.STEP_ID,TBCM.MAN_ID,STEP_BEGIN_AT FROM T_BIZ_CHECK_STEP TBCS
    INNER JOIN T_BIZ_CHECK_MAN TBCM ON TBCS.STEP_ID=TBCM.STEP_ID
    INNER JOIN T_SYS_USER TSU ON TSU.USER_ID=TBCM.USER_ID
    WHERE  TBCM.CHECK_STATE='PENDING'
    AND DATE_FORMAT(TBCS.STEP_CREATE_AT,'%Y-%m-%d') &lt; DATE_FORMAT(NOW(),'%Y-%m-%d')
    GROUP BY TBCS.CHECK_OBJ_ID,TSU.USER_ID,TBCS.STEP_ID,TBCM.MAN_ID

    ) B ON A.STEP_NO=B.STEP_NO
    AND A.DEAL_ID=B.CHECK_OBJ_ID

    UNION ALL

    SELECT B.STEP_ID,B.MAN_ID,B.CHECK_OBJ_ID NOTICE_OBJ_ID,'settle' NOTICE_OBJ_TYPE,IFNULL(B.STEP_BEGIN_AT,NOW()) NOTICE_SEND_TIME  FROM (
    SELECT IFNULL(MIN(TBCS.STEP_NO),-1) STEP_NO,TBS.SETTLE_ID FROM  T_BIZ_SETTLEMENT TBS
    INNER JOIN T_BIZ_DEAL TBD ON TBD.DEAL_ID=TBS.DEAL_ID
    INNER JOIN T_BIZ_CHECK_STEP TBCS ON TBCS.CHECK_OBJ_ID=TBS.SETTLE_ID
    INNER JOIN T_BIZ_CHECK_MAN TBCM ON TBCS.STEP_ID=TBCM.STEP_ID
    WHERE TBD.DEAL_STATUS='progressAuditing'
    AND TBCM.CHECK_STATE='PENDING'
    AND TBS.SETTLE_STATUS='buildAuditing'
    GROUP BY TBS.SETTLE_ID ) A
    INNER JOIN  (
    SELECT MIN(TBCS.STEP_NO) STEP_NO,TBCS.CHECK_OBJ_ID,TSU.USER_ID,TBCS.STEP_ID,TBCM.MAN_ID,STEP_BEGIN_AT FROM T_BIZ_CHECK_STEP TBCS
    INNER JOIN T_BIZ_CHECK_MAN TBCM ON TBCS.STEP_ID=TBCM.STEP_ID
    INNER JOIN T_SYS_USER TSU ON TSU.USER_ID=TBCM.USER_ID
    WHERE  TBCM.CHECK_STATE='PENDING'
    AND DATE_FORMAT(TBCS.STEP_CREATE_AT,'%Y-%m-%d') &lt; DATE_FORMAT(NOW(),'%Y-%m-%d')
    GROUP BY TBCS.CHECK_OBJ_ID,TSU.USER_ID,TBCS.STEP_ID,TBCM.MAN_ID
    ) B ON A.STEP_NO=B.STEP_NO
    AND A.SETTLE_ID=B.CHECK_OBJ_ID


  </select>


    <!--查询今日之前未审批-->
    <select id="selectContNextday" parameterType="java.util.Map" resultMap="BaseResultMap">

        SELECT B.STEP_ID,B.MAN_ID,B.CHECK_OBJ_ID NOTICE_OBJ_ID,'contProject' NOTICE_OBJ_TYPE,IFNULL(B.STEP_BEGIN_AT,NOW()) NOTICE_SEND_TIME FROM (
        SELECT IFNULL(MIN(TBCS.STEP_NO),-1) STEP_NO,TCP.PROJ_ID FROM  T_CONT_PROJECT TCP
        INNER JOIN T_BIZ_CHECK_STEP TBCS ON TBCS.CHECK_OBJ_ID=TCP.PROJ_ID
        INNER JOIN T_BIZ_CHECK_MAN TBCM ON TBCS.STEP_ID=TBCM.STEP_ID
        WHERE TCP.PROJ_STATE IN ('auditing')
        AND TBCM.CHECK_STATE='PENDING'
        GROUP BY TCP.PROJ_ID) A
        INNER JOIN  (

        SELECT MIN(TBCS.STEP_NO) STEP_NO,TBCS.CHECK_OBJ_ID,TSU.USER_ID,TBCS.STEP_ID,TBCM.MAN_ID,STEP_BEGIN_AT FROM T_BIZ_CHECK_STEP TBCS
        INNER JOIN T_BIZ_CHECK_MAN TBCM ON TBCS.STEP_ID=TBCM.STEP_ID
        INNER JOIN T_SYS_USER TSU ON TSU.USER_ID=TBCM.USER_ID
        WHERE  TBCM.CHECK_STATE='PENDING'
        AND DATE_FORMAT(TBCS.STEP_CREATE_AT,'%Y-%m-%d') &lt; DATE_FORMAT(NOW(),'%Y-%m-%d')
        GROUP BY TBCS.CHECK_OBJ_ID,TSU.USER_ID,TBCS.STEP_ID,TBCM.MAN_ID

        ) B ON A.STEP_NO=B.STEP_NO
        AND A.PROJ_ID=B.CHECK_OBJ_ID

        UNION ALL

        SELECT B.STEP_ID,B.MAN_ID,B.CHECK_OBJ_ID NOTICE_OBJ_ID,'access' NOTICE_OBJ_TYPE,IFNULL(B.STEP_BEGIN_AT,NOW()) NOTICE_SEND_TIME FROM (
        SELECT IFNULL(MIN(TBCS.STEP_NO),-1) STEP_NO,TCA.ACCE_ID FROM  T_CONT_ACCESS TCA
        INNER JOIN T_BIZ_CHECK_STEP TBCS ON TBCS.CHECK_OBJ_ID=TCA.ACCE_ID
        INNER JOIN T_BIZ_CHECK_MAN TBCM ON TBCS.STEP_ID=TBCM.STEP_ID
        WHERE TBCM.CHECK_STATE='PENDING'
        AND TCA.ACCE_STATE IN ('auditing')
        GROUP BY TCA.ACCE_ID ) A
        INNER JOIN  (
        SELECT MIN(TBCS.STEP_NO) STEP_NO,TBCS.CHECK_OBJ_ID,TSU.USER_ID,TBCS.STEP_ID,TBCM.MAN_ID,STEP_BEGIN_AT FROM T_BIZ_CHECK_STEP TBCS
        INNER JOIN T_BIZ_CHECK_MAN TBCM ON TBCS.STEP_ID=TBCM.STEP_ID
        INNER JOIN T_SYS_USER TSU ON TSU.USER_ID=TBCM.USER_ID
        WHERE  TBCM.CHECK_STATE='PENDING'
        AND DATE_FORMAT(TBCS.STEP_CREATE_AT,'%Y-%m-%d') &lt; DATE_FORMAT(NOW(),'%Y-%m-%d')
        GROUP BY TBCS.CHECK_OBJ_ID,TSU.USER_ID,TBCS.STEP_ID,TBCM.MAN_ID
        ) B ON A.STEP_NO=B.STEP_NO
        AND A.ACCE_ID=B.CHECK_OBJ_ID

        UNION ALL

        SELECT B.STEP_ID,B.MAN_ID,B.CHECK_OBJ_ID NOTICE_OBJ_ID,'creditSet' NOTICE_OBJ_TYPE,IFNULL(B.STEP_BEGIN_AT,NOW()) NOTICE_SEND_TIME FROM (
        SELECT IFNULL(MIN(TBCS.STEP_NO),-1) STEP_NO,TCCS.SET_ID FROM  T_CONT_CREDIT_SET TCCS
        INNER JOIN T_BIZ_CHECK_STEP TBCS ON TBCS.CHECK_OBJ_ID=TCCS.SET_ID
        INNER JOIN T_BIZ_CHECK_MAN TBCM ON TBCS.STEP_ID=TBCM.STEP_ID
        WHERE TBCM.CHECK_STATE='PENDING'
        AND TCCS.SET_STATE='auditing'
        GROUP BY TCCS.SET_ID ) A
        INNER JOIN  (
        SELECT MIN(TBCS.STEP_NO) STEP_NO,TBCS.CHECK_OBJ_ID,TSU.USER_ID,TBCS.STEP_ID,TBCM.MAN_ID,STEP_BEGIN_AT FROM T_BIZ_CHECK_STEP TBCS
        INNER JOIN T_BIZ_CHECK_MAN TBCM ON TBCS.STEP_ID=TBCM.STEP_ID
        INNER JOIN T_SYS_USER TSU ON TSU.USER_ID=TBCM.USER_ID
        WHERE  TBCM.CHECK_STATE='PENDING'
        AND DATE_FORMAT(TBCS.STEP_CREATE_AT,'%Y-%m-%d') &lt; DATE_FORMAT(NOW(),'%Y-%m-%d')
        GROUP BY TBCS.CHECK_OBJ_ID,TSU.USER_ID,TBCS.STEP_ID,TBCM.MAN_ID
        ) B ON A.STEP_NO=B.STEP_NO
        AND A.SET_ID=B.CHECK_OBJ_ID

    </select>

    <!--查询今日之前立项未审批-->
    <select id="selectProNextday" parameterType="java.util.Map" resultMap="BaseResultMap">

        SELECT B.STEP_ID,B.MAN_ID,B.CHECK_OBJ_ID NOTICE_OBJ_ID,'proProject' NOTICE_OBJ_TYPE,IFNULL(B.STEP_BEGIN_AT,NOW()) NOTICE_SEND_TIME FROM (
        SELECT IFNULL(MIN(TBCS.STEP_NO),-1) STEP_NO,TPP.PROJ_ID FROM  T_PROJ_PROJECT TPP
        INNER JOIN T_BIZ_CHECK_STEP TBCS ON TBCS.CHECK_OBJ_ID=TPP.PROJ_ID
        INNER JOIN T_BIZ_CHECK_MAN TBCM ON TBCS.STEP_ID=TBCM.STEP_ID
        WHERE TPP.PROJ_STATUS IN ('auditing')
        AND TBCM.CHECK_STATE='PENDING'
        GROUP BY TPP.PROJ_ID) A
        INNER JOIN  (

        SELECT MIN(TBCS.STEP_NO) STEP_NO,TBCS.CHECK_OBJ_ID,TSU.USER_ID,TBCS.STEP_ID,TBCM.MAN_ID,STEP_BEGIN_AT FROM T_BIZ_CHECK_STEP TBCS
        INNER JOIN T_BIZ_CHECK_MAN TBCM ON TBCS.STEP_ID=TBCM.STEP_ID
        INNER JOIN T_SYS_USER TSU ON TSU.USER_ID=TBCM.USER_ID
        WHERE  TBCM.CHECK_STATE='PENDING'
        AND DATE_FORMAT(TBCS.STEP_CREATE_AT,'%Y-%m-%d') &lt; DATE_FORMAT(NOW(),'%Y-%m-%d')
        GROUP BY TBCS.CHECK_OBJ_ID,TSU.USER_ID,TBCS.STEP_ID,TBCM.MAN_ID

        ) B ON A.STEP_NO=B.STEP_NO
        AND A.PROJ_ID=B.CHECK_OBJ_ID

        UNION ALL

        SELECT B.STEP_ID,B.MAN_ID,B.CHECK_OBJ_ID NOTICE_OBJ_ID,'selCont' NOTICE_OBJ_TYPE,IFNULL(B.STEP_BEGIN_AT,NOW()) NOTICE_SEND_TIME FROM (
        SELECT IFNULL(MIN(TBCS.STEP_NO),-1) STEP_NO,TPSC.SEL_CONT_ID FROM  T_PROJ_SEL_CONT TPSC
        INNER JOIN T_BIZ_CHECK_STEP TBCS ON TBCS.CHECK_OBJ_ID=TPSC.SEL_CONT_ID
        INNER JOIN T_BIZ_CHECK_MAN TBCM ON TBCS.STEP_ID=TBCM.STEP_ID
        WHERE TBCM.CHECK_STATE='PENDING'
        AND TPSC.PROJ_STATUS IN ('auditing')
        GROUP BY TPSC.SEL_CONT_ID ) A
        INNER JOIN  (
        SELECT MIN(TBCS.STEP_NO) STEP_NO,TBCS.CHECK_OBJ_ID,TSU.USER_ID,TBCS.STEP_ID,TBCM.MAN_ID,STEP_BEGIN_AT FROM T_BIZ_CHECK_STEP TBCS
        INNER JOIN T_BIZ_CHECK_MAN TBCM ON TBCS.STEP_ID=TBCM.STEP_ID
        INNER JOIN T_SYS_USER TSU ON TSU.USER_ID=TBCM.USER_ID
        WHERE  TBCM.CHECK_STATE='PENDING'
        AND DATE_FORMAT(TBCS.STEP_CREATE_AT,'%Y-%m-%d') &lt; DATE_FORMAT(NOW(),'%Y-%m-%d')
        GROUP BY TBCS.CHECK_OBJ_ID,TSU.USER_ID,TBCS.STEP_ID,TBCM.MAN_ID
        ) B ON A.STEP_NO=B.STEP_NO
        AND A.SEL_CONT_ID=B.CHECK_OBJ_ID

        UNION ALL

        SELECT B.STEP_ID,B.MAN_ID,B.CHECK_OBJ_ID NOTICE_OBJ_ID,'purchase' NOTICE_OBJ_TYPE,IFNULL(B.STEP_BEGIN_AT,NOW()) NOTICE_SEND_TIME FROM (
        SELECT IFNULL(MIN(TBCS.STEP_NO),-1) STEP_NO,TPPP.PLAN_ID FROM  T_PROJ_PURC_PLAN TPPP
        INNER JOIN T_BIZ_CHECK_STEP TBCS ON TBCS.CHECK_OBJ_ID=TPPP.PLAN_ID
        INNER JOIN T_BIZ_CHECK_MAN TBCM ON TBCS.STEP_ID=TBCM.STEP_ID
        WHERE TBCM.CHECK_STATE='PENDING'
        AND TPPP.PROJ_STATUS IN ('auditing')
        GROUP BY TPPP.PLAN_ID ) A
        INNER JOIN  (
        SELECT MIN(TBCS.STEP_NO) STEP_NO,TBCS.CHECK_OBJ_ID,TSU.USER_ID,TBCS.STEP_ID,TBCM.MAN_ID,STEP_BEGIN_AT FROM T_BIZ_CHECK_STEP TBCS
        INNER JOIN T_BIZ_CHECK_MAN TBCM ON TBCS.STEP_ID=TBCM.STEP_ID
        INNER JOIN T_SYS_USER TSU ON TSU.USER_ID=TBCM.USER_ID
        WHERE  TBCM.CHECK_STATE='PENDING'
        AND DATE_FORMAT(TBCS.STEP_CREATE_AT,'%Y-%m-%d') &lt; DATE_FORMAT(NOW(),'%Y-%m-%d')
        GROUP BY TBCS.CHECK_OBJ_ID,TSU.USER_ID,TBCS.STEP_ID,TBCM.MAN_ID
        ) B ON A.STEP_NO=B.STEP_NO
        AND A.PLAN_ID=B.CHECK_OBJ_ID


         UNION ALL

        SELECT B.STEP_ID,B.MAN_ID,B.CHECK_OBJ_ID NOTICE_OBJ_ID,'rePurchase' NOTICE_OBJ_TYPE,IFNULL(B.STEP_BEGIN_AT,NOW()) NOTICE_SEND_TIME FROM (
        SELECT IFNULL(MIN(TBCS.STEP_NO),-1) STEP_NO,TPPR.RESULT_ID FROM  T_PROJ_PURC_RESULT TPPR
        INNER JOIN T_BIZ_CHECK_STEP TBCS ON TBCS.CHECK_OBJ_ID=TPPR.RESULT_ID
        INNER JOIN T_BIZ_CHECK_MAN TBCM ON TBCS.STEP_ID=TBCM.STEP_ID
        WHERE TBCM.CHECK_STATE='PENDING'
        AND TPPR.PROJ_STATUS IN ('auditing')
        GROUP BY TPPR.RESULT_ID ) A
        INNER JOIN  (
        SELECT MIN(TBCS.STEP_NO) STEP_NO,TBCS.CHECK_OBJ_ID,TSU.USER_ID,TBCS.STEP_ID,TBCM.MAN_ID,STEP_BEGIN_AT FROM T_BIZ_CHECK_STEP TBCS
        INNER JOIN T_BIZ_CHECK_MAN TBCM ON TBCS.STEP_ID=TBCM.STEP_ID
        INNER JOIN T_SYS_USER TSU ON TSU.USER_ID=TBCM.USER_ID
        WHERE  TBCM.CHECK_STATE='PENDING'
        AND DATE_FORMAT(TBCS.STEP_CREATE_AT,'%Y-%m-%d') &lt; DATE_FORMAT(NOW(),'%Y-%m-%d')
        GROUP BY TBCS.CHECK_OBJ_ID,TSU.USER_ID,TBCS.STEP_ID,TBCM.MAN_ID
        ) B ON A.STEP_NO=B.STEP_NO
        AND A.RESULT_ID=B.CHECK_OBJ_ID

    </select>

</mapper>