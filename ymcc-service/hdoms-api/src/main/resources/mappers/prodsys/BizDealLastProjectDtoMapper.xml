<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.com.cnpc.cpoa.mapper.prodsys.BizDealLastProjectDtoMapper">

    <resultMap id="BaseResultMap" type="cn.com.cnpc.cpoa.domain.prodsys.BizProjectSumDataDto">
        <result column="PSD_ID" jdbcType="VARCHAR" property="psdId" />
        <result column="YEAR_MOMTH" jdbcType="VARCHAR" property="yearMonth" />
        <result column="CLIENT_ID" jdbcType="VARCHAR" property="clientId" />
        <result column="CLIENT_NAME" jdbcType="VARCHAR" property="clientName"/>
        <result column="MARKET_TYPE" jdbcType="VARCHAR" property="marketType" />
        <result column="COMPANY_TYPE" jdbcType="VARCHAR" property="companyType" />
        <result column="CONTRACT_TYPE" jdbcType="VARCHAR" property="contractType" />
        <result column="WORK_ZONE" jdbcType="VARCHAR" property="workZone" />
        <result column="WORK_TYPE" jdbcType="VARCHAR" property="workType" />
        <result column="BIZ_TYPE_ID" jdbcType="VARCHAR" property="bizTypeId" />
        <result column="CONTRACT_PRICE" jdbcType="DOUBLE" property="contractPrice" />
        <result column="NOTES" jdbcType="VARCHAR" property="notes" />
        <result column="DEPT_NAME" jdbcType="VARCHAR" property="deptName" />
        <result column="SUB_DEPT_NAME" jdbcType="VARCHAR" property="subDeptName" />
        <result column="DEPT_ID" jdbcType="VARCHAR" property="deptId" />
        <result column="WORK_TYPE1" jdbcType="VARCHAR" property="workType1" />
        <result column="WORK_TYPE2" jdbcType="VARCHAR" property="workType2" />
        <result column="SERV_TYPE" jdbcType="VARCHAR" property="servType" />
    </resultMap>

    <select id="selectListContractTypeAnalysisOne" parameterType="java.util.Map" resultMap="BaseResultMap">
        SELECT
        (
        CASE
        WHEN t.CONTRACT_TYPE = 'RELATED' THEN
        '关联交易'
        WHEN t.CONTRACT_TYPE = 'UNRELATED' THEN
        '非关联交易'
        ELSE
        '未知'
        END
        ) AS CONTRACT_TYPE,
        IFNULL(SUM(t.CONTRACT_PRICE), 0) AS CONTRACT_PRICE
        FROM
        V_DEAL_LAST_PRJ t
        <where>
            t.CONTRACT_TYPE IN ('RELATED', 'UNRELATED')
            AND T.DEAL_TYPE IN ('XS', 'XX')

            <if test="yearMonthStart!=null and yearMonthStart != ''">
                AND DATE_FORMAT(t.CREATE_DATE, '%Y%m%d') &gt;= #{yearMonthStart}
            </if>
            <if test="yearMonthEnd!=null and yearMonthEnd != ''">
                AND DATE_FORMAT(t.CREATE_DATE, '%Y%m%d') &lt;= #{yearMonthEnd}
            </if>

        </where>
        GROUP BY t.CONTRACT_TYPE

    </select>

    <select id="selectListContractTypeAnalysisTwo" parameterType="java.util.Map" resultMap="BaseResultMap">
        SELECT
        '划拨/指令性' AS CONTRACT_TYPE,
        IFNULL(SUM(t.CONTRACT_PRICE), 0) AS CONTRACT_PRICE
        FROM
        V_DEAL_LAST_PRJ t
        <where>
            t.DEAL_TYPE = 'INSTRUCTION'
            <if test="yearMonthStart!=null and yearMonthStart != ''">
                AND DATE_FORMAT(t.CREATE_DATE, '%Y%m%d') &gt;= #{yearMonthStart}
            </if>
            <if test="yearMonthEnd!=null and yearMonthEnd != ''">
                AND DATE_FORMAT(t.CREATE_DATE, '%Y%m%d') &lt;= #{yearMonthEnd}
            </if>

        </where>
    </select>

    <select id="selectListContractTypeAnalysisThree" parameterType="java.util.Map" resultMap="BaseResultMap">
        SELECT
        '三万以下' AS CONTRACT_TYPE,
        IFNULL(SUM(t.CONTRACT_PRICE), 0) AS CONTRACT_PRICE
        FROM
        V_DEAL_LAST_PRJ t
        <where>
            t.DEAL_TYPE = 'TH'
            <if test="yearMonthStart!=null and yearMonthStart != ''">
                AND DATE_FORMAT(t.CREATE_DATE, '%Y%m%d') &gt;= #{yearMonthStart}
            </if>
            <if test="yearMonthEnd!=null and yearMonthEnd != ''">
                AND DATE_FORMAT(t.CREATE_DATE, '%Y%m%d') &lt;= #{yearMonthEnd}
            </if>

        </where>
    </select>

    <select id="selectListContractTypeAnalysisNZ" parameterType="java.util.Map" resultMap="BaseResultMap">
        SELECT
        '内部责任书' AS CONTRACT_TYPE,
        IFNULL(SUM(t.CONTRACT_PRICE), 0) AS CONTRACT_PRICE
        FROM
        V_DEAL_LAST_PRJ t
        <where>
            t.DEAL_TYPE = 'NZ'
            <if test="yearMonthStart!=null and yearMonthStart != ''">
                AND DATE_FORMAT(t.CREATE_DATE, '%Y%m%d') &gt;= #{yearMonthStart}
            </if>
            <if test="yearMonthEnd!=null and yearMonthEnd != ''">
                AND DATE_FORMAT(t.CREATE_DATE, '%Y%m%d') &lt;= #{yearMonthEnd}
            </if>

        </where>
    </select>

    <select id="selectListClientDeptAnalysis" parameterType="java.util.Map" resultMap="BaseResultMap">
        SELECT
        SUM(V.CONTRACT_PRICE) CONTRACT_PRICE,
        V.parent_name DEPT_NAME
        FROM
        (
        SELECT
        IFNULL(p.CONTRACT_PRICE, 0) CONTRACT_PRICE,
        (CASE WHEN p.parent_name IS NULL OR p.parent_name = '' THEN '未知' ELSE p.parent_name END) parent_name
        FROM
        V_DEAL_LAST_PRJ p
        <where>
            1 = 1
            AND DATE_FORMAT(p.CREATE_DATE, '%Y%m%d') &gt;= #{yearMonthStart}
            AND DATE_FORMAT(p.CREATE_DATE, '%Y%m%d') &lt;= #{yearMonthEnd}
        </where>
        ) V
        GROUP BY
        V.parent_name
    </select>

    <select id="selectListClientSubDeptAnalysis" parameterType="java.util.Map" resultMap="BaseResultMap">
        SELECT
        IFNULL(SUM(p.CONTRACT_PRICE), 0) CONTRACT_PRICE,
        IFNULL(p.parent_name, '未知') DEPT_NAME,
        p.CONT_NAME SUB_DEPT_NAME
        FROM
        V_DEAL_LAST_PRJ p
        <where>
            1 = 1
            AND DATE_FORMAT(p.CREATE_DATE, '%Y%m') &gt;= #{yearMonthStart}
            AND DATE_FORMAT(p.CREATE_DATE, '%Y%m') &lt;= #{yearMonthEnd}
            AND p.PARENT_NAME = #{parentName}
        </where>
        GROUP BY
        p.parent_name, p.CONT_NAME
    </select>

    <select id="selectListMarketAreaAnalysis" parameterType="java.util.Map" resultMap="BaseResultMap">
        SELECT IFNULL(SUM(v.CONTRACT_PRICE), 0) as CONTRACT_PRICE, v.WORK_ZONE from (
        SELECT s.CONTRACT_PRICE,
        (CASE
        WHEN s.WORK_ZONE = 'SC_CQ_ZONE' THEN '川渝地区'
        WHEN s.WORK_ZONE = 'TLM_ZONE' THEN '塔里木地区'
        WHEN s.WORK_ZONE = 'XJ_ZONE' THEN '新疆地区'
        WHEN s.WORK_ZONE = 'CQ_ZONE' THEN '长庆地区'
        WHEN s.WORK_ZONE = 'HW_ZONE' THEN '海外地区'
        WHEN s.WORK_ZONE = 'HS_ZONE' THEN '海上地区'
        WHEN s.WORK_ZONE = 'BF_ZONE' THEN '北方地区'
        ELSE '其他' END) as WORK_ZONE
        FROM V_DEAL_LAST_PRJ s
        WHERE DATE_FORMAT(s.CREATE_DATE, '%Y%m%d') >= #{yearMonthStart} and DATE_FORMAT(s.CREATE_DATE, '%Y%m%d') &lt;= #{yearMonthEnd}
        ) v
        GROUP BY v.WORK_ZONE
    </select>

    <select id="selectListMarketAreaWorktype" parameterType="java.util.Map" resultMap="BaseResultMap">
        SELECT IFNULL(SUM(s.CONTRACT_PRICE), 0) as CONTRACT_PRICE, w.WORK_TYPE1 AS WORK_TYPE1
        FROM V_DEAL_LAST_PRJ s, T_BIZ_PROJECT p, T_BIZ_PROJECT_WORK pw, T_BIZ_WORK_TABLE w
        WHERE (s.DEAL_ID = p.deal_id or s.DEAL_ID = p.CONTRACT_ID)
        AND p.CONTRACT_ID = pw.CONTRACT_ID and pw.CLAS_ID = w.CLAS_ID
        AND DATE_FORMAT(s.CREATE_DATE, '%Y%m%d') >= #{yearMonthStart} and DATE_FORMAT(s.CREATE_DATE, '%Y%m%d') &lt;= #{yearMonthEnd} and s.WORK_ZONE = #{workZone}
        GROUP BY w.WORK_TYPE1
    </select>

    <select id="selectListMarketAreaServtype" parameterType="java.util.Map" resultMap="BaseResultMap">
        SELECT IFNULL(SUM(s.CONTRACT_PRICE), 0) as CONTRACT_PRICE, w.SERV_TYPE
        FROM V_DEAL_LAST_PRJ s, T_BIZ_PROJECT p, T_BIZ_PROJECT_WORK pw, T_BIZ_WORK_TABLE w
        WHERE (s.DEAL_ID = p.deal_id or s.DEAL_ID = p.CONTRACT_ID)
        AND p.CONTRACT_ID = pw.CONTRACT_ID and pw.CLAS_ID = w.CLAS_ID
        AND DATE_FORMAT(s.CREATE_DATE, '%Y%m%d') >= #{yearMonthStart} and DATE_FORMAT(s.CREATE_DATE, '%Y%m%d') &lt;= #{yearMonthEnd} and s.WORK_ZONE = #{workZone}
        and w.WORK_TYPE1 = #{workType1}
        GROUP BY w.SERV_TYPE
    </select>

    <select id="selectListClasWorkType1" parameterType="java.util.Map" resultMap="BaseResultMap">
        SELECT IFNULL(SUM(s.CONTRACT_PRICE), 0) as CONTRACT_PRICE, w.WORK_TYPE1
        FROM V_DEAL_LAST_PRJ s, T_BIZ_PROJECT p, T_BIZ_PROJECT_WORK pw, T_BIZ_WORK_TABLE w
        WHERE (s.DEAL_ID = p.deal_id or s.DEAL_ID = p.CONTRACT_ID)
        AND p.CONTRACT_ID = pw.CONTRACT_ID and pw.CLAS_ID = w.CLAS_ID
        AND DATE_FORMAT(s.CREATE_DATE, '%Y%m%d') >= #{yearMonthStart} and DATE_FORMAT(s.CREATE_DATE, '%Y%m%d') &lt;= #{yearMonthEnd}
        GROUP BY w.WORK_TYPE1
    </select>

    <select id="selectListClasWorkType2" parameterType="java.util.Map" resultMap="BaseResultMap">
        SELECT IFNULL(SUM(s.CONTRACT_PRICE), 0) as CONTRACT_PRICE, w.WORK_TYPE2
        FROM V_DEAL_LAST_PRJ s, T_BIZ_PROJECT p, T_BIZ_PROJECT_WORK pw, T_BIZ_WORK_TABLE w
        WHERE (s.DEAL_ID = p.deal_id or s.DEAL_ID = p.CONTRACT_ID)
        AND p.CONTRACT_ID = pw.CONTRACT_ID and pw.CLAS_ID = w.CLAS_ID
        AND DATE_FORMAT(s.CREATE_DATE, '%Y%m%d') >= #{yearMonthStart} and DATE_FORMAT(s.CREATE_DATE, '%Y%m%d') &lt;= #{yearMonthEnd}
        AND w.WORK_TYPE1 = #{workType1}
        GROUP BY w.WORK_TYPE2
    </select>

    <select id="selectListClasServType" parameterType="java.util.Map" resultMap="BaseResultMap">
        SELECT IFNULL(SUM(s.CONTRACT_PRICE), 0) as CONTRACT_PRICE, w.SERV_TYPE
        FROM V_DEAL_LAST_PRJ s, T_BIZ_PROJECT p, T_BIZ_PROJECT_WORK pw, T_BIZ_WORK_TABLE w
        WHERE (s.DEAL_ID = p.deal_id or s.DEAL_ID = p.CONTRACT_ID)
        AND p.CONTRACT_ID = pw.CONTRACT_ID and pw.CLAS_ID = w.CLAS_ID
        AND DATE_FORMAT(s.CREATE_DATE, '%Y%m%d') >= #{yearMonthStart} and DATE_FORMAT(s.CREATE_DATE, '%Y%m%d') &lt;= #{yearMonthEnd}
        AND w.WORK_TYPE1 = #{workType1}
        AND w.WORK_TYPE2 = #{workType2}
        GROUP BY w.SERV_TYPE
    </select>

    <select id="sumMonthly" parameterType="java.util.Map" resultType="String">
        SELECT IFNULL(SUM(TBPS.CONTRACT_PRICE), 0) CONTRACT_PRICE FROM V_DEAL_LAST_PRJ TBPS
        <where>
            <if test="yearMonth!=null and yearMonth!=''">
                AND DATE_FORMAT(TBPS.CREATE_DATE, '%Y%m') &lt;= #{yearMonth}
            </if>
            <if test="year!=null and year!=''">
                AND DATE_FORMAT(TBPS.CREATE_DATE, '%Y') = #{year}
            </if>
            <if test="dateStart!=null and dateStart!=''">
                AND TBPS.CREATE_DATE >= str_to_date(#{dateStart},'%Y-%m-%d')
            </if>
            <if test="dateEnd!=null and dateEnd!=''">
                AND TBPS.CREATE_DATE &lt;= str_to_date(#{dateEnd},'%Y-%m-%d')
            </if>
            <if test="marketType!=null and marketType!=''">
                AND TBPS.MARKET_TYPE = #{marketType}
            </if>
            <if test="companyType!=null and companyType!=''">
                AND TBPS.COMPANY_TYPE = #{companyType}
            </if>
            <if test="contractType!=null and contractType!=''">
                AND TBPS.CONTRACT_TYPE = #{contractType}
            </if>
            <if test="workZone!=null and workZone!=''">
                AND TBPS.WORK_ZONE = #{workZone}
            </if>
            <if test="workZoneNot!=null and workZoneNot!=''">
                AND TBPS.WORK_ZONE NOT IN ('SC_CQ_ZONE', 'CQ_ZONE', 'TLM_ZONE')
            </if>
        </where>
    </select>

</mapper>
